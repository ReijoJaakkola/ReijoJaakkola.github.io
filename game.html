<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explain This! â€” XAI Game</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #f0f9f4;
            --accent-primary: #10b981;
            --accent-secondary: #3b82f6;
            --accent-dark: #059669;
            --accent-danger: #ef4444;
            --accent-warning: #f59e0b;
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border-color: #d1fae5;
            --glow-primary: rgba(16, 185, 129, 0.3);
            --glow-danger: rgba(239, 68, 68, 0.3);
            --gradient-main: linear-gradient(135deg, #10b981 0%, #3b82f6 100%);
            --gradient-light: linear-gradient(135deg, #d1fae5 0%, #dbeafe 100%);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg-primary); color: var(--text-primary); line-height: 1.6; min-height: 100vh; }
        
        #particleNetwork { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        
        header { position: relative; z-index: 10; padding: 1.5rem 2rem; text-align: center; background: linear-gradient(180deg, rgba(255,255,255,0.95) 0%, rgba(240,249,244,0.8) 100%); border-bottom: 1px solid var(--border-color); }
        .back-link { position: absolute; left: 2rem; top: 50%; transform: translateY(-50%); color: var(--text-secondary); text-decoration: none; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; transition: color 0.3s; }
        .back-link:hover { color: var(--accent-primary); }
        header h1 { font-size: 1.75rem; font-weight: 700; background: var(--gradient-main); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        header p { color: var(--text-secondary); font-size: 0.9rem; }
        
        main { position: relative; z-index: 10; max-width: 1200px; margin: 0 auto; padding: 1.5rem; }
        
        .btn { display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.6rem 1.25rem; border: none; border-radius: 50px; font-family: 'Outfit', sans-serif; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .btn-primary { background: var(--gradient-main); color: white; box-shadow: 0 4px 15px var(--glow-primary); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 25px var(--glow-primary); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-secondary { background: white; color: var(--text-secondary); border: 2px solid var(--border-color); }
        .btn-secondary:hover { border-color: var(--accent-primary); color: var(--accent-primary); }
        .btn-danger { background: var(--accent-danger); color: white; }
        .btn-small { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
        
        /* Intro Screen */
        .game-intro { background: white; border-radius: 24px; padding: 2.5rem; text-align: center; border: 1px solid var(--border-color); box-shadow: 0 4px 20px rgba(0,0,0,0.03); }
        .game-intro h2 { font-size: 1.75rem; margin-bottom: 0.75rem; }
        .game-intro > p { color: var(--text-secondary); max-width: 600px; margin: 0 auto 1.5rem; }
        .alien-preview-container { display: flex; justify-content: center; gap: 1rem; margin: 1.5rem 0; flex-wrap: wrap; }
        .alien-preview-container svg { width: 70px; height: 90px; }
        
        .difficulty-select { display: flex; justify-content: center; gap: 1rem; margin-top: 1.5rem; flex-wrap: wrap; }
        .difficulty-btn { padding: 1rem 1.5rem; background: white; border: 2px solid var(--border-color); border-radius: 16px; cursor: pointer; transition: all 0.3s; text-align: left; min-width: 180px; }
        .difficulty-btn:hover { border-color: var(--accent-primary); transform: translateY(-2px); box-shadow: 0 4px 15px var(--glow-primary); }
        .difficulty-btn .diff-name { font-weight: 700; font-size: 1.1rem; margin-bottom: 0.25rem; }
        .difficulty-btn .diff-desc { font-size: 0.85rem; color: var(--text-muted); }
        .difficulty-btn .diff-example { font-size: 0.75rem; color: var(--accent-secondary); font-family: 'JetBrains Mono', monospace; margin-top: 0.5rem; }
        
        .how-to-play { margin-top: 2rem; padding: 1.5rem; background: rgba(59, 130, 246, 0.05); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 16px; text-align: left; max-width: 500px; margin-left: auto; margin-right: auto; }
        .how-to-play h3 { color: var(--accent-secondary); margin-bottom: 0.75rem; font-size: 1rem; }
        .how-to-play ol { color: var(--text-secondary); padding-left: 1.5rem; font-size: 0.9rem; }
        .how-to-play li { margin-bottom: 0.4rem; }
        
        /* Game Layout */
        .game-layout { display: grid; grid-template-columns: 1fr 350px; gap: 1.5rem; }
        @media (max-width: 900px) { .game-layout { grid-template-columns: 1fr; } }
        
        .game-main { display: flex; flex-direction: column; gap: 1.5rem; }
        
        /* Stats Bar */
        .game-stats { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; background: white; border-radius: 16px; border: 1px solid var(--border-color); flex-wrap: wrap; gap: 1rem; }
        .stat { text-align: center; }
        .stat-value { font-family: 'JetBrains Mono', monospace; font-size: 1.5rem; font-weight: 700; color: var(--accent-primary); }
        .stat-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; }
        
        /* Current Alien Display */
        .current-alien-section { background: white; border-radius: 20px; padding: 1.5rem; border: 1px solid var(--border-color); text-align: center; }
        .current-alien-section h3 { font-size: 1rem; color: var(--text-muted); margin-bottom: 1rem; }
        .alien-card { display: inline-block; background: var(--gradient-light); border-radius: 20px; padding: 1.5rem 2rem; margin-bottom: 1rem; }
        .alien-svg { width: 120px; height: 154px; }
        .decision-badge { display: inline-block; padding: 0.4rem 1rem; border-radius: 50px; font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; font-weight: 700; margin-top: 0.5rem; }
        .decision-badge.approved { background: rgba(16, 185, 129, 0.2); color: var(--accent-dark); }
        .decision-badge.rejected { background: rgba(239, 68, 68, 0.2); color: var(--accent-danger); }
        .decision-badge.unknown { background: rgba(148, 163, 184, 0.2); color: var(--text-muted); }
        
        .feature-list { display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center; margin-top: 1rem; }
        .feature-tag { padding: 0.4rem 0.8rem; border-radius: 50px; font-size: 0.8rem; font-family: 'JetBrains Mono', monospace; }
        .feature-tag.positive { background: rgba(16, 185, 129, 0.2); color: var(--accent-dark); }
        .feature-tag.negative { background: rgba(239, 68, 68, 0.15); color: var(--accent-danger); }
        
        /* Split View - Approved vs Rejected */
        .split-view { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .split-column { background: white; border-radius: 16px; padding: 1rem; border: 1px solid var(--border-color); min-height: 200px; }
        .split-column h4 { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.75rem; padding-bottom: 0.5rem; border-bottom: 2px solid; display: flex; align-items: center; gap: 0.5rem; }
        .split-column.approved-col h4 { color: var(--accent-primary); border-color: var(--accent-primary); }
        .split-column.rejected-col h4 { color: var(--accent-danger); border-color: var(--accent-danger); }
        .alien-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(55px, 1fr)); gap: 0.5rem; }
        .mini-alien-card { background: var(--gradient-light); border-radius: 10px; padding: 0.4rem; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .mini-alien-card:hover { transform: scale(1.05); border-color: var(--accent-secondary); }
        .mini-alien-card.highlighted { border-color: var(--accent-warning); box-shadow: 0 0 10px rgba(245, 158, 11, 0.4); }
        .mini-alien-card svg { width: 45px; height: 58px; display: block; margin: 0 auto; }
        
        /* Rule Builder Panel */
        .rule-builder-panel { background: white; border-radius: 20px; padding: 1.5rem; border: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 1rem; }
        .rule-builder-panel h3 { font-size: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        
        /* Drag tokens */
        .token-palette { display: flex; flex-direction: column; gap: 0.75rem; }
        .token-group { display: flex; flex-wrap: wrap; gap: 0.4rem; }
        .token-group-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.25rem; width: 100%; }
        
        .drag-token { padding: 0.4rem 0.75rem; border-radius: 8px; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; cursor: grab; transition: all 0.2s; user-select: none; border: 2px solid transparent; }
        .drag-token:hover { transform: translateY(-1px); }
        .drag-token:active { cursor: grabbing; }
        .drag-token.feature-true { background: rgba(16, 185, 129, 0.15); color: var(--accent-dark); }
        .drag-token.feature-true:hover { border-color: var(--accent-primary); }
        .drag-token.feature-false { background: rgba(239, 68, 68, 0.1); color: var(--accent-danger); }
        .drag-token.feature-false:hover { border-color: var(--accent-danger); }
        .drag-token.operator { background: var(--accent-secondary); color: white; }
        .drag-token.operator:hover { background: #2563eb; }
        .drag-token.paren { background: var(--text-muted); color: white; }
        
        /* Drop Zone */
        .drop-zone { min-height: 60px; background: #f8fafc; border: 2px dashed var(--border-color); border-radius: 12px; padding: 0.75rem; display: flex; flex-wrap: wrap; gap: 0.4rem; align-items: center; transition: all 0.2s; }
        .drop-zone.drag-over { border-color: var(--accent-secondary); background: rgba(59, 130, 246, 0.05); }
        .drop-zone.valid { border-color: var(--accent-primary); background: rgba(16, 185, 129, 0.05); }
        .drop-zone.invalid { border-color: var(--accent-danger); background: rgba(239, 68, 68, 0.05); }
        .drop-zone-placeholder { color: var(--text-muted); font-size: 0.85rem; width: 100%; text-align: center; }
        
        .placed-token { padding: 0.4rem 0.75rem; border-radius: 8px; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; display: inline-flex; align-items: center; gap: 0.4rem; cursor: pointer; transition: all 0.2s; }
        .placed-token:hover { opacity: 0.8; }
        .placed-token .remove-token { font-size: 0.7rem; opacity: 0.6; }
        .placed-token .remove-token:hover { opacity: 1; }
        .placed-token.feature-true { background: rgba(16, 185, 129, 0.15); color: var(--accent-dark); }
        .placed-token.feature-false { background: rgba(239, 68, 68, 0.1); color: var(--accent-danger); }
        .placed-token.operator { background: var(--accent-secondary); color: white; }
        .placed-token.paren { background: var(--text-muted); color: white; }
        
        /* Validation Message */
        .validation-msg { font-size: 0.8rem; padding: 0.5rem 0.75rem; border-radius: 8px; display: flex; align-items: center; gap: 0.5rem; }
        .validation-msg.valid { background: rgba(16, 185, 129, 0.1); color: var(--accent-dark); }
        .validation-msg.invalid { background: rgba(239, 68, 68, 0.1); color: var(--accent-danger); }
        .validation-msg.empty { background: rgba(148, 163, 184, 0.1); color: var(--text-muted); }
        
        /* Rule Preview */
        .rule-preview { background: #f8fafc; border-radius: 12px; padding: 1rem; }
        .rule-preview h4 { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem; }
        .preview-aliens { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .preview-alien { width: 36px; height: 46px; border-radius: 6px; overflow: hidden; border: 2px solid; }
        .preview-alien.would-approve { border-color: var(--accent-primary); background: rgba(16, 185, 129, 0.1); }
        .preview-alien.would-reject { border-color: var(--accent-danger); background: rgba(239, 68, 68, 0.1); }
        .preview-alien svg { width: 100%; height: 100%; }
        .preview-stats { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem; }
        
        /* Builder Actions */
        .builder-actions { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        
        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center; padding: 1rem; }
        .modal-overlay.active { display: flex; }
        .modal { background: white; border-radius: 24px; padding: 2rem; max-width: 450px; width: 100%; text-align: center; max-height: 90vh; overflow-y: auto; }
        .modal h2 { font-size: 1.5rem; margin-bottom: 0.5rem; }
        .modal .result-icon { font-size: 3.5rem; margin-bottom: 0.5rem; }
        .modal .score-display { font-family: 'JetBrains Mono', monospace; font-size: 1.25rem; color: var(--accent-primary); margin: 0.5rem 0; }
        .modal p { color: var(--text-secondary); margin-bottom: 1rem; }
        .modal .actual-rule { background: var(--gradient-light); padding: 1rem; border-radius: 12px; font-family: 'JetBrains Mono', monospace; margin-bottom: 1.5rem; font-size: 0.9rem; }
        .modal-buttons { display: flex; justify-content: center; gap: 0.75rem; flex-wrap: wrap; }
        

        /* Animations */
        @keyframes pop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .animate-pop { animation: pop 0.3s ease; }
        .animate-shake { animation: shake 0.3s ease; }
        
        /* Responsive */
        @media (max-width: 768px) {
            header { padding: 1rem; }
            .back-link { position: static; transform: none; justify-content: center; margin-bottom: 0.75rem; }
            main { padding: 1rem; }
            .split-view { grid-template-columns: 1fr; }
            .game-stats { justify-content: center; }
            .difficulty-btn { min-width: 100%; }
        }
    </style>
</head>
<body>
    <canvas id="particleNetwork"></canvas>
    
    <header>
        <a href="index.html" class="back-link"><i class="fas fa-arrow-left"></i> Back to Home</a>
        <h1>ðŸ›¸ Explain This!</h1>
        <p>Discover the hidden rule behind alien visa approvals</p>
    </header>
    
    <main>
        <!-- Intro Screen -->
        <div class="game-intro" id="introScreen">
            <div class="alien-preview-container" id="previewAliens"></div>
            <h2>Welcome to Galactic Immigration!</h2>
            <p>Aliens want Earth visas, but the approval rules are SECRET. Study the approved and rejected cases, find the pattern, and build a Boolean rule to crack the code!</p>
            
            <div class="difficulty-select">
                <button class="difficulty-btn" onclick="startGame('easy')">
                    <div class="diff-name">ðŸŒ± Easy</div>
                    <div class="diff-desc">Single feature rules</div>
                    <div class="diff-example">e.g., "Green"</div>
                </button>
                <button class="difficulty-btn" onclick="startGame('medium')">
                    <div class="diff-name">ðŸŒ¿ Medium</div>
                    <div class="diff-desc">Two features with AND/OR</div>
                    <div class="diff-example">e.g., "Green AND Horns"</div>
                </button>
                <button class="difficulty-btn" onclick="startGame('hard')">
                    <div class="diff-name">ðŸŒ³ Hard</div>
                    <div class="diff-desc">Complex nested logic</div>
                    <div class="diff-example">e.g., "(Green AND Antenna) OR Horns"</div>
                </button>
            </div>
            
            <div class="how-to-play">
                <h3><i class="fas fa-question-circle"></i> How to Play</h3>
                <ol>
                    <li>Click "Next Alien" to reveal applicants one by one</li>
                    <li>Study the features and compare approved vs rejected aliens</li>
                    <li>Drag & drop tokens to build your rule hypothesis</li>
                    <li>Watch the preview to see if your rule matches the pattern</li>
                    <li>Submit when confident â€” fewer examples = better score!</li>
                </ol>
            </div>
        </div>
        
        <!-- Game Screen -->
        <div class="game-layout" id="gameScreen" style="display: none;">
            <div class="game-main">
                <!-- Stats -->
                <div class="game-stats">
                    <div class="stat">
                        <div class="stat-value" id="examplesCount">0</div>
                        <div class="stat-label">Examples Seen</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="approvedCount">0</div>
                        <div class="stat-label">Approved</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="rejectedCount">0</div>
                        <div class="stat-label">Rejected</div>
                    </div>
                    <button class="btn btn-primary" onclick="showNextAlien()">
                        <i class="fas fa-arrow-right"></i> Next Alien
                    </button>
                </div>
                
                <!-- Current Alien -->
                <div class="current-alien-section" id="currentAlienSection">
                    <h3 id="currentAlienTitle">Current Applicant</h3>
                    <div class="alien-card" id="currentAlienCard">
                        <div id="currentAlienSvg"></div>
                    </div>
                    <div id="currentDecision"></div>
                    <div class="feature-list" id="currentFeatures"></div>
                </div>
                
                <!-- Split View -->
                <div class="split-view">
                    <div class="split-column approved-col">
                        <h4><i class="fas fa-check-circle"></i> Approved</h4>
                        <div class="alien-grid" id="approvedGrid"></div>
                    </div>
                    <div class="split-column rejected-col">
                        <h4><i class="fas fa-times-circle"></i> Rejected</h4>
                        <div class="alien-grid" id="rejectedGrid"></div>
                    </div>
                </div>
            </div>
            
            <!-- Rule Builder Sidebar -->
            <div class="rule-builder-panel">
                <h3><i class="fas fa-lightbulb"></i> Build Your Rule</h3>
                
                <!-- Token Palette -->
                <div class="token-palette">
                    <div class="token-group">
                        <div class="token-group-label">Features (has)</div>
                        <div class="drag-token feature-true" draggable="true" data-type="feature" data-key="green" data-value="true">Green</div>
                        <div class="drag-token feature-true" draggable="true" data-type="feature" data-key="threeEyes" data-value="true">3 Eyes</div>
                        <div class="drag-token feature-true" draggable="true" data-type="feature" data-key="hasAntenna" data-value="true">Antenna</div>
                        <div class="drag-token feature-true" draggable="true" data-type="feature" data-key="hasLegs" data-value="true">Legs</div>
                        <div class="drag-token feature-true" draggable="true" data-type="feature" data-key="hasHorns" data-value="true">Horns</div>
                        <div class="drag-token feature-true" draggable="true" data-type="feature" data-key="isSmiling" data-value="true">Smiling</div>
                    </div>
                    <div class="token-group">
                        <div class="token-group-label">Features (lacks)</div>
                        <div class="drag-token feature-false" draggable="true" data-type="feature" data-key="green" data-value="false">Not Green</div>
                        <div class="drag-token feature-false" draggable="true" data-type="feature" data-key="threeEyes" data-value="false">Two Eyes</div>
                        <div class="drag-token feature-false" draggable="true" data-type="feature" data-key="hasAntenna" data-value="false">No Antenna</div>
                        <div class="drag-token feature-false" draggable="true" data-type="feature" data-key="hasLegs" data-value="false">No Legs</div>
                        <div class="drag-token feature-false" draggable="true" data-type="feature" data-key="hasHorns" data-value="false">No Horns</div>
                        <div class="drag-token feature-false" draggable="true" data-type="feature" data-key="isSmiling" data-value="false">Not Smiling</div>
                    </div>
                    <div class="token-group">
                        <div class="token-group-label">Operators</div>
                        <div class="drag-token operator" draggable="true" data-type="operator" data-value="AND">AND</div>
                        <div class="drag-token operator" draggable="true" data-type="operator" data-value="OR">OR</div>
                        <div class="drag-token paren" draggable="true" data-type="paren" data-value="(">(</div>
                        <div class="drag-token paren" draggable="true" data-type="paren" data-value=")">)</div>
                    </div>
                </div>
                
                <!-- Drop Zone -->
                <div class="drop-zone" id="dropZone">
                    <span class="drop-zone-placeholder">Drag tokens here to build your rule...</span>
                </div>
                
                <!-- Validation -->
                <div class="validation-msg empty" id="validationMsg">
                    <i class="fas fa-info-circle"></i>
                    <span>Start building your rule</span>
                </div>
                
                <!-- Rule Preview -->
                <div class="rule-preview" id="rulePreview">
                    <h4><i class="fas fa-eye"></i> Preview: Which aliens would match?</h4>
                    <div class="preview-aliens" id="previewAliens2"></div>
                    <div class="preview-stats" id="previewStats">Build a valid rule to see preview</div>
                </div>
                
                <!-- Actions -->
                <div class="builder-actions">
                    <button class="btn btn-secondary btn-small" onclick="undoToken()">
                        <i class="fas fa-undo"></i> Undo
                    </button>
                    <button class="btn btn-secondary btn-small" onclick="clearRule()">
                        <i class="fas fa-trash"></i> Clear
                    </button>
                    <button class="btn btn-primary" onclick="submitRule()" id="submitBtn" disabled>
                        <i class="fas fa-check"></i> Submit Rule
                    </button>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Result Modal -->
    <div class="modal-overlay" id="resultModal">
        <div class="modal">
            <div class="result-icon" id="resultIcon">ðŸŽ‰</div>
            <h2 id="resultTitle">Correct!</h2>
            <div class="score-display" id="resultScore"></div>
            <p id="resultMessage"></p>
            <div class="actual-rule">
                <strong>The Rule:</strong><br>
                <span id="actualRule"></span>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="backToMenu()">
                    <i class="fas fa-home"></i> Menu
                </button>
                <button class="btn btn-primary" onclick="playAgain()">
                    <i class="fas fa-redo"></i> Play Again
                </button>
            </div>
        </div>
    </div>
    


    <script>
        // Game State
        let gameState = {
            difficulty: 'easy',
            currentRule: null,
            examples: [],
            ruleTokens: [],
            shownCombos: new Set(),
            highlightedFeatures: null
        };
        
        // Features
        const features = {
            green: { name: 'Green', trueLabel: 'Green', falseLabel: 'Not Green' },
            threeEyes: { name: '3 Eyes', trueLabel: 'Three Eyes', falseLabel: 'Two Eyes' },
            hasAntenna: { name: 'Antenna', trueLabel: 'Has Antenna', falseLabel: 'No Antenna' },
            hasLegs: { name: 'Legs', trueLabel: 'Has Legs', falseLabel: 'No Legs (Tentacles)' },
            hasHorns: { name: 'Horns', trueLabel: 'Has Horns', falseLabel: 'No Horns' },
            isSmiling: { name: 'Smiling', trueLabel: 'Smiling', falseLabel: 'Not Smiling' }
        };
        
        // Rule Templates
        const ruleTemplates = {
            easy: [
                { rule: a => a.green, description: 'Green' },
                { rule: a => !a.green, description: 'Not Green' },
                { rule: a => a.threeEyes, description: 'Three Eyes' },
                { rule: a => a.hasAntenna, description: 'Antenna' },
                { rule: a => a.hasLegs, description: 'Legs' },
                { rule: a => a.hasHorns, description: 'Horns' },
                { rule: a => a.isSmiling, description: 'Smiling' },
                { rule: a => !a.isSmiling, description: 'Not Smiling' },
            ],
            medium: [
                { rule: a => a.green && a.hasAntenna, description: 'Green AND Antenna' },
                { rule: a => a.threeEyes || a.hasLegs, description: 'Three Eyes OR Legs' },
                { rule: a => a.hasHorns && a.isSmiling, description: 'Horns AND Smiling' },
                { rule: a => a.green && a.threeEyes, description: 'Green AND Three Eyes' },
                { rule: a => a.hasAntenna || a.hasHorns, description: 'Antenna OR Horns' },
                { rule: a => !a.green && a.isSmiling, description: 'Not Green AND Smiling' },
                { rule: a => a.threeEyes && a.hasHorns, description: 'Three Eyes AND Horns' },
                { rule: a => a.green || a.hasAntenna, description: 'Green OR Antenna' },
                { rule: a => !a.hasLegs && a.hasHorns, description: 'No Legs AND Horns' },
            ],
            hard: [
                { rule: a => (a.green && a.hasAntenna) || a.threeEyes, description: '(Green AND Antenna) OR Three Eyes' },
                { rule: a => a.hasLegs && (a.green || a.hasHorns), description: 'Legs AND (Green OR Horns)' },
                { rule: a => (a.isSmiling || a.hasAntenna) && a.threeEyes, description: '(Smiling OR Antenna) AND Three Eyes' },
                { rule: a => (a.hasHorns && a.threeEyes) || (a.green && a.isSmiling), description: '(Horns AND Three Eyes) OR (Green AND Smiling)' },
                { rule: a => a.green && a.hasHorns && a.hasAntenna, description: 'Green AND Horns AND Antenna' },
                { rule: a => (a.hasLegs || a.threeEyes) && a.isSmiling, description: '(Legs OR Three Eyes) AND Smiling' },
                { rule: a => (a.green || a.hasHorns) && (a.hasAntenna || a.isSmiling), description: '(Green OR Horns) AND (Antenna OR Smiling)' },
                { rule: a => (!a.green && a.hasAntenna) || a.hasHorns, description: '(Not Green AND Antenna) OR Horns' },
            ]
        };
        
        // Alien Generation
        function alienToKey(a) {
            return `${a.green}-${a.threeEyes}-${a.hasAntenna}-${a.hasLegs}-${a.hasHorns}-${a.isSmiling}`;
        }
        
        function generateAlien() {
            if (gameState.shownCombos.size >= 64) gameState.shownCombos.clear();
            let alien, key, attempts = 0;
            do {
                alien = {
                    green: Math.random() > 0.5,
                    threeEyes: Math.random() > 0.5,
                    hasAntenna: Math.random() > 0.5,
                    hasLegs: Math.random() > 0.5,
                    hasHorns: Math.random() > 0.5,
                    isSmiling: Math.random() > 0.5
                };
                key = alienToKey(alien);
                attempts++;
            } while (gameState.shownCombos.has(key) && attempts < 100);
            gameState.shownCombos.add(key);
            return alien;
        }
        
        function generateAlienSVG(alien, size = 'normal') {
            const w = size === 'mini' ? 45 : size === 'preview' ? 36 : 120;
            const h = size === 'mini' ? 58 : size === 'preview' ? 46 : 154;
            
            const greenColors = [
                { body: '#10b981', dark: '#059669', light: '#6ee7b7' },
                { body: '#22c55e', dark: '#16a34a', light: '#86efac' },
                { body: '#14b8a6', dark: '#0d9488', light: '#5eead4' },
            ];
            const otherColors = [
                { body: '#8b5cf6', dark: '#7c3aed', light: '#c4b5fd' },
                { body: '#ec4899', dark: '#db2777', light: '#f9a8d4' },
                { body: '#f97316', dark: '#ea580c', light: '#fdba74' },
                { body: '#ef4444', dark: '#dc2626', light: '#fca5a5' },
                { body: '#3b82f6', dark: '#2563eb', light: '#93c5fd' },
            ];
            
            const seed = (alien.green ? 1 : 0) + (alien.threeEyes ? 2 : 0) + (alien.hasAntenna ? 4 : 0) + 
                        (alien.hasLegs ? 8 : 0) + (alien.hasHorns ? 16 : 0) + (alien.isSmiling ? 32 : 0);
            
            const colorSet = alien.green ? greenColors[seed % greenColors.length] : otherColors[seed % otherColors.length];
            const { body, dark, light } = colorSet;
            
            let svg = `<svg width="${w}" height="${h}" viewBox="0 0 120 154">`;
            
            // Horns
            if (alien.hasHorns) {
                svg += `<path d="M 30 42 Q 20 22 30 12" stroke="${dark}" stroke-width="5" fill="none" stroke-linecap="round"/>
                        <path d="M 90 42 Q 100 22 90 12" stroke="${dark}" stroke-width="5" fill="none" stroke-linecap="round"/>`;
            }
            
            // Antenna
            if (alien.hasAntenna) {
                svg += `<line x1="60" y1="38" x2="60" y2="12" stroke="${dark}" stroke-width="3"/>
                        <circle cx="60" cy="10" r="6" fill="${dark}"/>`;
            }
            
            // Body
            svg += `<ellipse cx="60" cy="82" rx="38" ry="45" fill="${body}"/>
                    <ellipse cx="60" cy="78" rx="30" ry="36" fill="${dark}" opacity="0.15"/>`;
            
            // Eyes
            if (alien.threeEyes) {
                svg += `<ellipse cx="40" cy="68" rx="9" ry="10" fill="white"/>
                        <ellipse cx="60" cy="60" rx="9" ry="10" fill="white"/>
                        <ellipse cx="80" cy="68" rx="9" ry="10" fill="white"/>
                        <circle cx="40" cy="70" r="4" fill="#1e293b"/>
                        <circle cx="60" cy="62" r="4" fill="#1e293b"/>
                        <circle cx="80" cy="70" r="4" fill="#1e293b"/>`;
            } else {
                svg += `<ellipse cx="45" cy="68" rx="10" ry="12" fill="white"/>
                        <ellipse cx="75" cy="68" rx="10" ry="12" fill="white"/>
                        <circle cx="45" cy="70" r="5" fill="#1e293b"/>
                        <circle cx="75" cy="70" r="5" fill="#1e293b"/>`;
            }
            
            // Mouth
            if (alien.isSmiling) {
                svg += `<path d="M 45 95 Q 60 110 75 95" stroke="${dark}" stroke-width="3" fill="none" stroke-linecap="round"/>`;
            } else {
                svg += `<line x1="48" y1="98" x2="72" y2="98" stroke="${dark}" stroke-width="3" stroke-linecap="round"/>`;
            }
            
            // Legs or Tentacles
            if (alien.hasLegs) {
                svg += `<rect x="45" y="123" width="10" height="24" rx="5" fill="${body}"/>
                        <rect x="65" y="123" width="10" height="24" rx="5" fill="${body}"/>
                        <ellipse cx="50" cy="148" rx="7" ry="4" fill="${dark}"/>
                        <ellipse cx="70" cy="148" rx="7" ry="4" fill="${dark}"/>`;
            } else {
                svg += `<path d="M 35 123 Q 25 138 35 150" stroke="${body}" stroke-width="6" fill="none" stroke-linecap="round"/>
                        <path d="M 50 125 Q 45 140 50 152" stroke="${body}" stroke-width="6" fill="none" stroke-linecap="round"/>
                        <path d="M 70 125 Q 75 140 70 152" stroke="${body}" stroke-width="6" fill="none" stroke-linecap="round"/>
                        <path d="M 85 123 Q 95 138 85 150" stroke="${body}" stroke-width="6" fill="none" stroke-linecap="round"/>`;
            }
            
            return svg + '</svg>';
        }
        
        // Game Functions
        function startGame(difficulty) {
            gameState = {
                difficulty,
                currentRule: null,
                examples: [],
                ruleTokens: [],
                shownCombos: new Set(),
                highlightedFeatures: null
            };
            
            const templates = ruleTemplates[difficulty];
            gameState.currentRule = templates[Math.floor(Math.random() * templates.length)];
            
            document.getElementById('introScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'grid';
            
            updateStats();
            clearRule();
            document.getElementById('approvedGrid').innerHTML = '';
            document.getElementById('rejectedGrid').innerHTML = '';
            document.getElementById('currentAlienSvg').innerHTML = '<div style="color: var(--text-muted); padding: 2rem;">Click "Next Alien" to start!</div>';
            document.getElementById('currentDecision').innerHTML = '';
            document.getElementById('currentFeatures').innerHTML = '';
            document.getElementById('currentAlienTitle').textContent = 'Current Applicant';
        }
        
        function showNextAlien() {
            if (gameState.shownCombos.size >= 64) {
                alert("You've seen all 64 unique aliens!");
                return;
            }
            
            const alien = generateAlien();
            const approved = gameState.currentRule.rule(alien);
            alien.approved = approved;
            alien.id = gameState.examples.length;
            gameState.examples.push(alien);
            
            // Show current alien with features
            displayAlienInMain(alien, 'Current Applicant');
            
            // Add to split view
            const grid = approved ? document.getElementById('approvedGrid') : document.getElementById('rejectedGrid');
            const card = document.createElement('div');
            card.className = 'mini-alien-card';
            card.innerHTML = generateAlienSVG(alien, 'mini');
            card.onclick = () => displayAlienInMain(alien, 'Selected Applicant');
            card.onmouseenter = () => highlightSimilarFeatures(alien);
            card.onmouseleave = () => clearHighlights();
            card.dataset.alienId = alien.id;
            grid.appendChild(card);
            
            updateStats();
            updateRulePreview();
        }
        
        function displayAlienInMain(alien, title) {
            document.getElementById('currentAlienTitle').textContent = title;
            document.getElementById('currentAlienSvg').innerHTML = generateAlienSVG(alien);
            document.getElementById('currentDecision').innerHTML = `
                <div class="decision-badge ${alien.approved ? 'approved' : 'rejected'}">
                    ${alien.approved ? 'âœ“ APPROVED' : 'âœ— REJECTED'}
                </div>`;
            
            document.getElementById('currentFeatures').innerHTML = Object.keys(features).map(key => {
                const hasFeature = alien[key];
                return `<span class="feature-tag ${hasFeature ? 'positive' : 'negative'}">
                    ${hasFeature ? features[key].trueLabel : features[key].falseLabel}
                </span>`;
            }).join('');
            
            document.getElementById('currentAlienSection').classList.add('animate-pop');
            setTimeout(() => document.getElementById('currentAlienSection').classList.remove('animate-pop'), 300);
        }
        
        function updateStats() {
            const approved = gameState.examples.filter(e => e.approved).length;
            const rejected = gameState.examples.filter(e => !e.approved).length;
            document.getElementById('examplesCount').textContent = gameState.examples.length;
            document.getElementById('approvedCount').textContent = approved;
            document.getElementById('rejectedCount').textContent = rejected;
        }
        
        // Feature Highlighting (#13)
        function highlightSimilarFeatures(alien) {
            const relevantExamples = gameState.examples.filter(e => e.approved === alien.approved && e.id !== alien.id);
            
            document.querySelectorAll('.mini-alien-card').forEach(card => {
                const id = parseInt(card.dataset.alienId);
                const ex = gameState.examples.find(e => e.id === id);
                if (!ex || ex.id === alien.id) return;
                
                if (ex.approved === alien.approved) {
                    // Count shared features
                    let shared = 0;
                    Object.keys(features).forEach(key => {
                        if (alien[key] === ex[key]) shared++;
                    });
                    if (shared >= 4) card.classList.add('highlighted');
                }
            });
        }
        
        function clearHighlights() {
            document.querySelectorAll('.mini-alien-card.highlighted').forEach(card => {
                card.classList.remove('highlighted');
            });
        }
        

        // Drag & Drop Rule Builder (#3)
        let draggedToken = null;
        
        document.querySelectorAll('.drag-token').forEach(token => {
            token.addEventListener('dragstart', e => {
                draggedToken = {
                    type: token.dataset.type,
                    key: token.dataset.key,
                    value: token.dataset.value,
                    label: token.textContent
                };
                token.style.opacity = '0.5';
            });
            
            token.addEventListener('dragend', e => {
                token.style.opacity = '1';
                draggedToken = null;
            });
            
            // Also allow click to add
            token.addEventListener('click', () => {
                addToken({
                    type: token.dataset.type,
                    key: token.dataset.key,
                    value: token.dataset.value,
                    label: token.textContent
                });
            });
        });
        
        const dropZone = document.getElementById('dropZone');
        
        dropZone.addEventListener('dragover', e => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });
        
        dropZone.addEventListener('drop', e => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            if (draggedToken) {
                addToken(draggedToken);
            }
        });
        
        function addToken(token) {
            gameState.ruleTokens.push(token);
            renderRuleTokens();
            validateRule();
            updateRulePreview();
        }
        
        function removeToken(index) {
            gameState.ruleTokens.splice(index, 1);
            renderRuleTokens();
            validateRule();
            updateRulePreview();
        }
        
        function undoToken() {
            if (gameState.ruleTokens.length > 0) {
                gameState.ruleTokens.pop();
                renderRuleTokens();
                validateRule();
                updateRulePreview();
            }
        }
        
        function clearRule() {
            gameState.ruleTokens = [];
            renderRuleTokens();
            validateRule();
            updateRulePreview();
        }
        
        function renderRuleTokens() {
            const dropZone = document.getElementById('dropZone');
            
            if (gameState.ruleTokens.length === 0) {
                dropZone.innerHTML = '<span class="drop-zone-placeholder">Drag tokens here to build your rule...</span>';
                return;
            }
            
            dropZone.innerHTML = gameState.ruleTokens.map((token, index) => {
                let className = 'placed-token ';
                if (token.type === 'feature') {
                    className += token.value === 'true' ? 'feature-true' : 'feature-false';
                } else if (token.type === 'operator') {
                    className += 'operator';
                } else {
                    className += 'paren';
                }
                
                return `<span class="${className}" onclick="removeToken(${index})">
                    ${token.label}
                    <span class="remove-token">Ã—</span>
                </span>`;
            }).join('');
        }
        
        // Rule Validation (#16)
        function validateRule() {
            const tokens = gameState.ruleTokens;
            const msgEl = document.getElementById('validationMsg');
            const submitBtn = document.getElementById('submitBtn');
            
            if (tokens.length === 0) {
                msgEl.className = 'validation-msg empty';
                msgEl.innerHTML = '<i class="fas fa-info-circle"></i><span>Start building your rule</span>';
                submitBtn.disabled = true;
                dropZone.classList.remove('valid', 'invalid');
                return false;
            }
            
            // Check parentheses balance
            let parenCount = 0;
            for (const token of tokens) {
                if (token.value === '(') parenCount++;
                if (token.value === ')') parenCount--;
                if (parenCount < 0) {
                    msgEl.className = 'validation-msg invalid';
                    msgEl.innerHTML = '<i class="fas fa-exclamation-circle"></i><span>Unexpected closing parenthesis</span>';
                    submitBtn.disabled = true;
                    dropZone.classList.remove('valid');
                    dropZone.classList.add('invalid');
                    return false;
                }
            }
            
            if (parenCount !== 0) {
                msgEl.className = 'validation-msg invalid';
                msgEl.innerHTML = '<i class="fas fa-exclamation-circle"></i><span>Unclosed parenthesis</span>';
                submitBtn.disabled = true;
                dropZone.classList.remove('valid');
                dropZone.classList.add('invalid');
                return false;
            }
            
            // Check structure: can't have two operators or two features in a row
            for (let i = 0; i < tokens.length - 1; i++) {
                const curr = tokens[i];
                const next = tokens[i + 1];
                
                if (curr.type === 'operator' && next.type === 'operator') {
                    msgEl.className = 'validation-msg invalid';
                    msgEl.innerHTML = '<i class="fas fa-exclamation-circle"></i><span>Two operators in a row</span>';
                    submitBtn.disabled = true;
                    dropZone.classList.remove('valid');
                    dropZone.classList.add('invalid');
                    return false;
                }
                
                if (curr.type === 'feature' && next.type === 'feature') {
                    msgEl.className = 'validation-msg invalid';
                    msgEl.innerHTML = '<i class="fas fa-exclamation-circle"></i><span>Missing operator between features</span>';
                    submitBtn.disabled = true;
                    dropZone.classList.remove('valid');
                    dropZone.classList.add('invalid');
                    return false;
                }
            }
            
            // Can't start or end with operator
            if (tokens[0].type === 'operator') {
                msgEl.className = 'validation-msg invalid';
                msgEl.innerHTML = '<i class="fas fa-exclamation-circle"></i><span>Can\'t start with an operator</span>';
                submitBtn.disabled = true;
                dropZone.classList.remove('valid');
                dropZone.classList.add('invalid');
                return false;
            }
            
            const lastToken = tokens[tokens.length - 1];
            if (lastToken.type === 'operator') {
                msgEl.className = 'validation-msg invalid';
                msgEl.innerHTML = '<i class="fas fa-exclamation-circle"></i><span>Can\'t end with an operator</span>';
                submitBtn.disabled = true;
                dropZone.classList.remove('valid');
                dropZone.classList.add('invalid');
                return false;
            }
            
            // Must have at least one feature
            if (!tokens.some(t => t.type === 'feature')) {
                msgEl.className = 'validation-msg invalid';
                msgEl.innerHTML = '<i class="fas fa-exclamation-circle"></i><span>Rule needs at least one feature</span>';
                submitBtn.disabled = true;
                dropZone.classList.remove('valid');
                dropZone.classList.add('invalid');
                return false;
            }
            
            // Try to compile it
            try {
                buildRuleFunction();
                msgEl.className = 'validation-msg valid';
                msgEl.innerHTML = '<i class="fas fa-check-circle"></i><span>Valid rule!</span>';
                submitBtn.disabled = false;
                dropZone.classList.remove('invalid');
                dropZone.classList.add('valid');
                return true;
            } catch (e) {
                msgEl.className = 'validation-msg invalid';
                msgEl.innerHTML = '<i class="fas fa-exclamation-circle"></i><span>Invalid rule structure</span>';
                submitBtn.disabled = true;
                dropZone.classList.remove('valid');
                dropZone.classList.add('invalid');
                return false;
            }
        }
        
        function buildRuleFunction() {
            const expr = gameState.ruleTokens.map(t => {
                if (t.type === 'feature') {
                    return t.value === 'true' ? `a.${t.key}` : `!a.${t.key}`;
                } else if (t.type === 'operator') {
                    return t.value === 'AND' ? '&&' : '||';
                } else {
                    return t.value;
                }
            }).join(' ');
            
            return new Function('a', `return ${expr};`);
        }
        
        // Rule Preview (#21)
        function updateRulePreview() {
            const previewEl = document.getElementById('previewAliens2');
            const statsEl = document.getElementById('previewStats');
            
            if (gameState.ruleTokens.length === 0 || !validateRule()) {
                previewEl.innerHTML = '';
                statsEl.textContent = 'Build a valid rule to see preview';
                return;
            }
            
            try {
                const ruleFn = buildRuleFunction();
                
                // Test against seen examples
                let correctCount = 0;
                previewEl.innerHTML = gameState.examples.slice(-8).map(alien => {
                    const wouldApprove = ruleFn(alien);
                    const isCorrect = wouldApprove === alien.approved;
                    if (isCorrect) correctCount++;
                    
                    return `<div class="preview-alien ${wouldApprove ? 'would-approve' : 'would-reject'}" 
                                style="${!isCorrect ? 'opacity: 0.5;' : ''}">
                        ${generateAlienSVG(alien, 'preview')}
                    </div>`;
                }).join('');
                
                const total = Math.min(8, gameState.examples.length);
                if (total > 0) {
                    const pct = Math.round(correctCount / total * 100);
                    statsEl.innerHTML = `Matches <strong>${correctCount}/${total}</strong> recent examples (${pct}%)`;
                } else {
                    statsEl.textContent = 'See more aliens to test your rule';
                }
            } catch (e) {
                previewEl.innerHTML = '';
                statsEl.textContent = 'Invalid rule';
            }
        }
        
        // Submit & Check
        function submitRule() {
            if (!validateRule()) return;
            
            try {
                const playerRule = buildRuleFunction();
                
                // Test against all seen examples
                for (const ex of gameState.examples) {
                    if (playerRule(ex) !== ex.approved) {
                        showResult(false);
                        return;
                    }
                }
                
                // Test against random unseen aliens
                for (let i = 0; i < 50; i++) {
                    const testAlien = {
                        green: Math.random() > 0.5,
                        threeEyes: Math.random() > 0.5,
                        hasAntenna: Math.random() > 0.5,
                        hasLegs: Math.random() > 0.5,
                        hasHorns: Math.random() > 0.5,
                        isSmiling: Math.random() > 0.5
                    };
                    if (playerRule(testAlien) !== gameState.currentRule.rule(testAlien)) {
                        showResult(false);
                        return;
                    }
                }
                
                showResult(true);
            } catch (e) {
                showResult(false);
            }
        }
        
        function showResult(correct) {
            document.getElementById('resultIcon').textContent = correct ? 'ðŸŽ‰' : 'ðŸ˜¢';
            document.getElementById('resultTitle').textContent = correct ? 'Correct!' : 'Not Quite...';
            document.getElementById('resultScore').textContent = correct 
                ? `Solved in ${gameState.examples.length} examples!` 
                : 'Your rule didn\'t match the pattern';
            document.getElementById('resultMessage').textContent = correct
                ? 'You cracked the code! Can you do it with fewer examples?'
                : 'The rule was different from your guess. Try again!';
            document.getElementById('actualRule').textContent = gameState.currentRule.description;
            document.getElementById('resultModal').classList.add('active');
        }
        
        function playAgain() {
            document.getElementById('resultModal').classList.remove('active');
            startGame(gameState.difficulty);
        }
        
        function backToMenu() {
            document.getElementById('resultModal').classList.remove('active');
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('introScreen').style.display = 'block';
        }
        
        // Preview aliens for intro
        function showPreviewAliens() {
            const samples = [
                { green: true, threeEyes: false, hasAntenna: true, hasLegs: true, hasHorns: false, isSmiling: true },
                { green: false, threeEyes: true, hasAntenna: false, hasLegs: false, hasHorns: true, isSmiling: false },
                { green: true, threeEyes: true, hasAntenna: true, hasLegs: false, hasHorns: true, isSmiling: true },
                { green: false, threeEyes: false, hasAntenna: false, hasLegs: true, hasHorns: false, isSmiling: false },
            ];
            document.getElementById('previewAliens').innerHTML = samples.map(a => generateAlienSVG(a)).join('');
        }
        
        // Particle Background
        const canvas = document.getElementById('particleNetwork');
        const ctx = canvas.getContext('2d');
        let mouse = { x: null, y: null };

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        document.addEventListener('mousemove', e => { mouse.x = e.clientX; mouse.y = e.clientY; });
        document.addEventListener('mouseleave', () => { mouse.x = null; mouse.y = null; });

        const particles = [];
        for (let i = 0; i < 60; i++) {
            particles.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                vx: (Math.random() - 0.5) * 0.8,
                vy: (Math.random() - 0.5) * 0.8,
                radius: Math.random() * 2.5 + 1.5,
                color: ['#10b981', '#3b82f6', '#06b6d4'][Math.floor(Math.random() * 3)]
            });
        }

        function animateParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach((p, i) => {
                if (mouse.x && mouse.y) {
                    const dx = mouse.x - p.x, dy = mouse.y - p.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < 150) { p.x -= dx * 0.015; p.y -= dy * 0.015; }
                }
                p.x += p.vx; p.y += p.vy;
                if (p.x < 0 || p.x > canvas.width) p.vx *= -1;
                if (p.y < 0 || p.y > canvas.height) p.vy *= -1;
                
                for (let j = i + 1; j < particles.length; j++) {
                    const p2 = particles[j];
                    const dx = p.x - p2.x, dy = p.y - p2.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < 120) {
                        ctx.beginPath();
                        ctx.moveTo(p.x, p.y);
                        ctx.lineTo(p2.x, p2.y);
                        ctx.strokeStyle = `rgba(16, 185, 129, ${1 - dist / 120})`;
                        ctx.stroke();
                    }
                }
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                ctx.fillStyle = p.color;
                ctx.fill();
            });
            requestAnimationFrame(animateParticles);
        }
        
        // Init
        showPreviewAliens();
        animateParticles();
    </script>
</body>
</html>